#!/bin/sh

. idioms
. "@@libdir@@"/theory.sh

myusage() { usage "pkg-gen THEORY..."; }

[ "$#" -gt 0 ] || myusage

while [ "$#" -gt 0 ]; do
    is_package_dir "${1}" || die 1 "'${1}' is not a directory containing a package"

    set -e

    printf '%s\n' \
        '#!/bin/sh' \
        '# Generated by @@name@@-@@version@@' \
        '' \
        '## Default theory script follows...'

    printf 'export %s="%s"\n' \
        "DISTFILES" "@@cachedir@@/distfiles" \
        "BUILDDIR" "@@builddir@@/${1##*/}" \
        "IMAGE" "\${BUILDDIR}/image"

    theory-construct-metadata "@@libdir@@/public"
    theory-construct-action "@@libdir@@/public"

    printf '\n%s\n' '## Package contents follows...'
    theory-construct-metadata -r "${1}"
    theory-construct-action -r "${1}"

    # This shouldn't be expanded anyway.
    # shellcheck disable=SC2016
    printf '%s\n' \
        '' \
        '[ $# -eq 0 ] && exec cat "$0"' \
        '"$@"'

    shift
done
