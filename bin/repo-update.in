#!/bin/sh

. "@@libdir@@"/flow.sh

usage() { pdie "usage: %s [-cdv] [REPOSITORY...]\n" "${0##*/}"; }

changes=false
dry_run=false
verbose=false

git_verbose=
git_quiet=true
while getopts :cdv arg >/dev/null 2>&1; do
	case "${arg}" in
		c)
			changes=true
			;;
		d)
			dry_run=true
			;;
		v)
			verbose=true
			git_verbose=true
			git_quiet=
			;;
		?)
			perror "unknown argument -- %s\n" "${OPTARG}"
			usage
			;;
	esac
done
shift $((OPTIND - 1))

pdo=
"${verbose}" && pdo="pdo"
"${dry_run}" && pdo="pdo -n"
"${dry_run}" || [ -w "@@dbdir@@"/repositories ] ||
	perror -d "Can't write to repositories directory '%s'\n" "@@dbdir@@/repositories"

# We want to split on words here.
# shellcheck disable=SC2046
[ $# -gt 0 ] || set -- $(repo-list)

for repo in "$@"; do
	repo_loc="@@dbdir@@/repositories/${repo}"
	[ -d "${repo_loc}" ] || perror -d "'%s' is not a repository\n" "${repo_loc}"

	if [ -x "${repo_loc}"/.git ]; then
		repo_branch=$(git -C "${repo_loc}" rev-parse --abbrev-ref HEAD)
		${pdo} git -C "${repo_loc}" fetch ${git_quiet:+-q} ${git_verbose:+-v} origin "${repo_branch}"

		if "${changes}" && [ "$(git -C "${repo_loc}" log --oneline '..@{u}' | wc -l)" -gt 0 ]; then
			before_date=$(git -C "${repo_loc}" show -s --format=%cd --date=human-local HEAD)
			printf 'Changes in %s since %s:\n' "${repo}" "${before_date}"
			PAGER='cat' ${pdo} git -C "${repo_loc}" log \
				--reverse \
				--format="$(printf '\t%s' '%C(yellow)%h%C(reset) %s (%aN <%aE>)')" \
				'..@{u}'
		fi

		${pdo} git -C "${repo_loc}" reset --hard ${git_quiet:+-q} origin/"${repo_branch}"
	else
		pwarning "unsure of how to update '%s'\n" "${repo}"
	fi
done

shift $#
for repo in $(repo-list -l | tac); do
	set -- "$@" "@@dbdir@@/repositories/${repo}/libraries"
done

if [ "$#" -gt 0 ]; then
	${pdo} s6-update-symlinks "@@dbdir@@/libraries" "$@"
fi

shift $#
for repo in $(repo-list -p | tac); do
	set -- "$@" "@@dbdir@@/repositories/${repo}/packages"
done

if [ "$#" -gt 0 ]; then
	${pdo} s6-update-symlinks "@@dbdir@@/packages" "$@"
fi
