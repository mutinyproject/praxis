#!/bin/sh

. "@@libdir@@"/flow.sh

dry_run=false
verbose=false
while getopts :dv arg >/dev/null 2>&1; do
	case "${arg}" in
		d)
			dry_run=true
			;;
		v)
			verbose=true
			;;
		?)
			error "unknown argument -- %s\n" "${OPTARG}"
			die "usage: %s [-dv]\n" "${0##*/}"
			;;
	esac
done
shift $(( OPTIND - 1 ))

edo=

"${verbose}" && edo="edo"
"${dry_run}" && edo="edo -d"
"${dry_run}" || [ -w "@@dbdir@@"/repositories ] || \
	error -d "Can't write to repositories directory '%s'\n" "@@dbdir@@/repositories"
"${verbose}" || verbose=

for repo in $(repo-list); do
	if [ -x "@@dbdir@@"/repositories/"${repo}"/.git ]; then
		${edo} git -C "@@dbdir@@"/repositories/"${repo}" fetch ${verbose:+-v} origin
		${edo} git -C "@@dbdir@@"/repositories/"${repo}" reset --hard origin/master
	else
		warning "unsure of how to update '%s'\n" "${repo}"
	fi
done

shift $#
for repo in $(repo-list -l | tac); do
	set -- "$@" "@@dbdir@@"/repositories/"${repo}"/libraries
done

if [ "$#" -gt 0 ]; then
	${edo} s6-update-symlinks "@@dbdir@@"/libraries "$@"
fi

shift $#
for repo in $(repo-list -p | tac); do
	set -- "$@" "@@dbdir@@"/repositories/"${repo}"/packages
done

if [ "$#" -gt 0 ]; then
	${edo} s6-update-symlinks "@@dbdir@@"/packages "$@"
fi

