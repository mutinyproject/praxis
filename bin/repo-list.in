#!/bin/sh

. "@@libdir@@"/flow.sh
. "@@libdir@@"/file.sh

libraries_only=false
packages_only=false

usage() { die "usage: %s [-lp]\n" "${0##*/}"; }

while getopts :lp arg >/dev/null 2>&1; do
	case "${arg}" in
		l)
			libraries_only=true
			;;
		p)
			packages_only=true
			;;
		?)
			error "unknown argument -- %s\n" "${OPTARG}"
			usage
			;;
	esac
done
shift $(( OPTIND - 1 ))

for repo in "@@dbdir@@"/repositories/*; do
	if "${libraries_only}"; then
		test -d "${repo}"/libraries && ! is_empty "${repo}"/libraries || continue
	fi
	if "${packages_only}"; then
		test -d "${repo}"/packages && ! is_empty "${repo}"/packages || continue
	fi

	[ -r "${repo}"/metadata/priority ] && \
		printf '%s:%s\n' "$(<"${repo}"/metadata/priority)" "${repo##*/}"
done | sort -t: -k 1n | cut -d: -f2-

