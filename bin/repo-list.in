#!/bin/sh

. "@@libdir@@"/flow.sh
. "@@libdir@@"/file.sh

libraries_only=false
packages_only=false

usage() { pdie "usage: %s [-lp]\n" "${0##*/}"; }

while getopts :lp arg >/dev/null 2>&1; do
	case "${arg}" in
		l)
			libraries_only=true
			;;
		p)
			packages_only=true
			;;
		?)
			perror "unknown argument -- %s\n" "${OPTARG}"
			usage
			;;
	esac
done
shift $((OPTIND - 1))

for repo in "@@dbdir@@"/repositories/*; do
	"${libraries_only}" && is_empty "${repo}"/libraries && continue
	"${packages_only}" && is_empty "${repo}"/packages && continue

	[ -r "${repo}"/metadata/priority ] &&
		printf '%s:%s\n' "$(cat "${repo}"/metadata/priority)" "${repo##*/}"
done | sort -t: -k 1n | cut -d: -f2-
