#!/bin/sh

. "@@libdir@@"/flow.sh
. "@@libdir@@"/theory.sh
. "@@libdir@@"/text.sh

usage() { die "usage: %s [-r] [-a OUTPUT] [-o OUTPUT] THEORY...\n" "${0##*/}"; }

append=false
overwrite=false
recurse=false
while getopts :ra:o: arg >/dev/null 2>&1; do
	case "${arg}" in
		r)
			recurse=true
			;;
		a)
			append=true
			exec >> "${OPTARG}"
			;;
		o)
			overwrite=true
			exec > "${OPTARG}"
			;;
		?)
			error "unknown argument -- %s\n" "${OPTARG}"
			usage
			;;
	esac
	"${append}" && "${overwrite}" && error -d "-a and -o are mutually exclusive\n"
done
shift $(( OPTIND - 1 ))

[ "$#" -gt 0 ] || usage

while [ "$#" -gt 0 ]; do
	is_theory_dir "${1}" || error -d "'%s' is not a directory containing a package or library\n" "${1}"
	theory=$(readlink -f "${1}")

	if "${recurse}" && [ -r "${1}"/libraries ]; then
		backslash "${1}"/libraries | while read -r library arguments; do
			theory-action -r "@@dbdir@@"/libraries/"${library}"
		done
	fi

	if test -r "${1}"/action -a -s "${1}"/action; then
		sh -n "${1}"/action || error -d "syntax error in '%s', dying\n" "${1}/action"
		cat "${1}"/action
	else
		exit 0
	fi

	shift
done
