#!/bin/mksh
#
# Riot, a from-source package manager for Mutiny Linux.
#
# Copyright (c) 2016 Kylie McClain <kylie@somasis.com>
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

# shellcheck disable=SC1091
. "@@libdir@@/riot/internal_functions.sh"
# shellcheck disable=SC1091
. "@@libdir@@/riot/default_functions.sh"

export PATH="${PATH}:@@libexecdir@@/riot"

export pkgprefix="@@pkgprefix@@"
export pkgexec_prefix="@@pkgexec_prefix@@"
export pkgbindir="@@pkgbindir@@"
export pkgsbindir="@@pkgsbindir@@"
export pkglibdir="@@pkglibdir@@"
export pkglibexecdir="@@pkglibexecdir@@"
export pkgdatarootdir="@@pkgdatarootdir@@"
export pkgdatadir="@@pkgdatadir@@"
export pkgdocdir="@@pkgdocdir@@"
export pkginfodir="@@pkginfodir@@"
export pkgmandir="@@pkgmandir@@"
export pkgsysconfdir="@@pkgsysconfdir@@"
export CHOST="@@CHOST@@"
export CBUILD="@@CBUILD@@"
export CTARGET="@@CTARGET@@"

export BUILDDIR="@@BUILDDIR@@"
export CACHEDIR="@@CACHEDIR@@"
export INSTALLDBDIR="@@INSTALLDBDIR@@"
export PKGDIR="@@PKGDIR@@"
export PHASE=
export riot_phases="pkg_fetch pkg_unpack pkg_prepare pkg_configure pkg_compile pkg_check pkg_install pkg_premerge pkg_merge pkg_postmerge"
export riot_install_phases="${riot_phases}"
export riot_debug=false
export riot_verbose=false
export riot_quiet=false
export JOBS=$(riot_jobs)

riot_version() {
    printf 'riot %s\n' "@@VERSION@@"
}

riot_help() {
    printf 'usage: riot [-c <always|auto|never>] [-j jobs] [-dqv] <action> [pkgs]\n\n'
    printf '%s: %s\n'   \
        "default build directory"       "${BUILDDIR}"      \
        "default cache directory"       "${CACHEDIR}"      \
        "default installdb directory"   "${INSTALLDBDIR}"  \
        "default package directory"     "${PKGDIR}"
}

riot_invalid() {
    printf 'riot: %s: unknown %s\n' "${1}" "${2:-command}" >&2
    exit 127
}

riot_color_init auto

while getopts :c:j:dqv opt;do
    case "${opt}" in
        c)
            riot_color_init "${OPTARG}"
        ;;
        j)
            case "${OPTARG}" in
                [0-9]*)
                    export JOBS="${OPTARG}"
                ;;
                *)
                    riot_invalid "-j: ${OPTARG}" "number"
                ;;
            esac
        ;;
        v)
            export riot_verbose=true
        ;;
        d)
            export riot_debug=true
        ;;
        q)
            export riot_quiet=true
        ;;
    esac
done

shift $(( OPTIND - 1 ))

riot_initialize

case "${1:-help}" in
    add|install)
        shift
        # shellcheck disable=SC2068
        riot_pkg_install "$@"
    ;;
    info)
        shift
        riot_pkg_info "$@"
    ;;
    version)
        riot_version
        exit 0
    ;;
    help)
        riot_help
        exit 0
    ;;
    *)
        if command -v riot-"${1}" >/dev/null 2>&1;then
            riot-"${1}"
            exit $?
        else
            riot_invalid "$1"
        fi
    ;;
esac

