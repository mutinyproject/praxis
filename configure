#!/bin/sh

usage() {
cat <<EOF
Usage: $0 [OPTION]... [VAR=VALUE]

To assign environment variables (e.g., CC, CFLAGS...), specify them as
VAR=VALUE.  See below for descriptions of some of the useful variables.

Defaults for the options are specified in brackets.

Configuration:
    -h, --help              display this help and exit
    --srcdir=DIR            source directory [detected]

Installation directories:
    --prefix=DIR            main installation prefix [/usr/local]
    --exec-prefix=DIR       installation prefix for executable files [prefix]

Fine tuning of the installation directories:
    --bindir=DIR            user executables [exec-prefix/bin]
    --datadir=DIR           read-only arch-independent data [datarootdir]
    --datarootdir=DIR       read-only arch-independent data root [prefix/share]
    --docdir=DIR            documentation root [datarootdir/doc/riot]
    --dvidir=DIR            dvi documentation [docdir]
    --htmldir=DIR           html documentation [docdir]
    --includedir=DIR        C header files [prefix/include]
    --infodir=DIR           info documentation [datarootdir/info]
    --libdir=DIR            object code libraries [exec-prefix/lib]
    --libexecdir=DIR        program executables [exec-prefix/libexec]
    --localedir=DIR         locale-dependent data [datarootdir/locale]
    --localstatedir=DIR     modifiable single-machine data [prefix/var]
    --mandir=DIR            man documentation [datarootdir/man]
    --pdfdir=DIR            pdf documentation [docdir]
    --psdir=DIR             ps documentation [docdir]
    --sbindir=DIR           system admin executables [exec-prefix/sbin]
    --sharedstatedir=DIR    modifiable architecture-independent data [prefix/com]
    --sysconfdir=DIR        read-only single-machine data [prefix/etc]

Riot build environment configuration:
    --defaultpath=PATH      default PATH used in build environment [bindir:sbindir]
    --builddir=DIR          directory used for building packages in [localstatedir/tmp/riot]
    --cachedir=DIR          directory for caching downloaded files [localstatedir/cache/riot]
    --installdir=DIR        directory for keeping information about installed packages [localstatedir/db/riot/installed]
    --repodir=DIR           directory where package repositories will be kept [localstatedir/db/riot/packages]

    --target=TARGET         passed to package ./configure scripts by default [${CTARGET-${CHOST-unknown}}]
    --host=HOST             passed to package ./configure scripts by default [${CHOST-unknown}]
    --build=BUILD           passed to package ./configure scripts by default [${CBUILD-${CHOST-unknown}}]

These configuration variables are used for the build environment Riot creates
when building packages.

Some influential environment variables:
    AR              Static library archiver command [detected]
    AS              Assembler command [detected]
    CC              C compiler command [detected]
    CPP             C pre-processor [detected]
    CXX             C++ compiler command [detected]
    LD              Linker command [detected]
    NM              Symbol list command [detected]
    OBJCOPY         Object copying command [detected]
    OBJDUMP         Object dumping command [detected]
    PKG_CONFIG      pkg-config command [detected]
    RANLIB          Static library indexer command [detected]

Any variable which is manually stated on the configure arguments will be passed
down into Riot build environments and exported.

EOF
exit 0
}

quote() {
    printf '%s' "$1" | sed -e "s/'/'\\\\''/g" -e "1s/^/'/" -e "\$s/\$/'/"
}

fail() { printf '%s\n' "$*"; exit 1; }

cmdline="$0 $@"

variables="
    target host build srcdir
    defaultpath
    builddir cachedir repodir installdir
    bindir datadir datarootdir docdir exec-prefix libdir libexecdir
    localstatedir mandir prefix sbindir sysconfdir
"

while [ $# -ne 0 ];do
    case "${1}" in
        -h|--help) usage ;;
        --*)
            for v in ${variables};do
                v="${v%%:*}"
                v_clean=$(printf %s "${v}" | tr '-' '_')
                eval "
                    case \"${1}\" in
                        --${v})     shift; ${v_clean}=\"\${1}\"; break >/dev/null 2>&1 ;;
                        --${v}=)    ${v_clean}=\"\"; break >/dev/null 2>&1 ;;
                        --${v}=*)   ${v_clean}=\"\${1#*=}\"; break >/dev/null 2>&1 ;;
                        --*)         : ;;
                        *)          printf '%s: WARNING: unrecognized options: %s\n' "${0}" "${1}" >&2; break >/dev/null 2>&1 ;;
                    esac
                "
            done
        ;;
        *=*) eval "${1%%=*}=$(quote "${1#*=}")"; manual_variables="${manual_variables} ${1%%=*}" ;;
        *) printf '%s: WARNING: unrecognized options: %s\n' "${0##*/}" "${1}" >&2 ;;
    esac
    shift
done

srcdir=${srcdir-${0%/configure}}
prefix=${prefix-/usr/local}
exec_prefix=${exec_prefix-$prefix}
bindir=${bindir-$exec_prefix/bin}
sbindir=${sbindir-$exec_prefix/sbin}
libexecdir=${libexecdir-$exec_prefix/libexec}
sysconfdir=${sysconfdir-$prefix/etc}
sharedstatedir=${sharedstatedir-$prefix/com}
localstatedir=${localstatedir-$prefix/var}
libdir=${libdir-$exec_prefix/lib}
includedir=${includedir-$prefix/include}
datarootdir=${datarootdir-$prefix/share}
datadir=${datadir-$datarootdir}
infodir=${infodir-$datarootdir/info}
localedir=${localedir-$datarootdir/locale}
mandir=${mandir-$datarootdir/man}
docdir=${docdir-$datarootdir/doc/riot}
htmldir=${htmldir-$docdir}
dvidir=${dvidir-$docdir}
pdfdir=${pdfdir-$docdir}
psdir=${psdir-$docdir}
host=${host-$CHOST}
target=${target-${host-${CTARGET-$CHOST}}}
build=${build-${host-${CBUILD-$CHOST}}}

builddir=${builddir-${localstatedir}/tmp/riot}
cachedir=${cachedir-${localstatedir}/cache/riot}
repodir=${repodir-${localstatedir}/db/riot/repositories}
installdir=${installdir-${localstatedir}/db/riot/installed}
defaultpath=${defaultpath-$bindir:$sbindir}

for v in ${variables} ${manual_variables};do
    v=$(printf %s "${v}" | tr '-' '_')
    printf '%s = %s\n' "${v#*:}" $(eval "printf %s \"\$${v%%:*}\"")
done

cat >config.mak <<EOF
# This version of config.mak was generated by:
# $cmdline
# Any changes made here will be lost if configure is re-run
$(for v in ${variables};do
    v=$(printf %s "${v}" | tr '-' '_')
    printf '%s = %s\n' "${v#*:}" $(eval "printf %s \"\$${v%%:*}\"")
done)


bin/%.sh: \$(srcdir)/bin/%.sh.in
	cp "\$(srcdir)/$<" "\$@"
	sed 's|@version@|\$(version)|g' -i "\$@"
$(for v in ${variables};do
    v=$(printf %s "${v%%:*}" | tr '-' '_')
    printf "\tsed 's|@%s@|\$(%s)|g' -i \"\$@\"\n" "${v}" "${v}"
done)
	chmod +x "\$@"
lib/%.sh: \$(srcdir)/lib/%.sh.in
	[ \$< = env.sh.in ] || cp "\$(srcdir)/$<" "\$@"
	sed 's|@version@|\$(version)|g' -i "\$@"
$(for v in ${variables};do
    v=$(printf %s "${v%%:*}" | tr '-' '_')
    printf "\tsed 's|@%s@|\$(%s)|g' -i \"\$@\"\n" "${v}" "${v}"
done)
EOF

mkdir -p lib

cat >lib/env.sh.in <<EOF
# This version of env.sh was generated by:
# $cmdline

ALLOWED_VARIABLES=( )

# Content from distributed env.sh.in.in
$(cat "${srcdir}"/lib/env.sh.in.in)

# Content from configuration variables
$(for v in ${manual_variables};do
    printf 'export %s="%s"\n' "${v}" $(eval "printf %s \"\$${v}\"")
    printf 'ALLOWED_VARIABLES+=( "%s" )\n' "${v}"
done)

$(if [ -f lib/env.distro.sh.in ];then
    printf '# %s\n' "Content from env.distro.sh.in"
    cat lib/env.distro.sh.in 2>/dev/null
fi)

EOF
test "$srcdir" = "." || ln -sf $srcdir/Makefile .

printf "done\n"
