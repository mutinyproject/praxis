#!/bin/sh

if [ -z "${NO_COLOR}" ]; then
	color_red=$(tput setaf 1)
	color_yellow=$(tput setaf 3)
	color_reset=$(tput sgr0)
fi

edo() {
	local dry_run=false die=false arg
	while [ $# -gt 0 ] && [ "${1:0:1}" = '-' ]; do
		case "$1" in
			-n)
				local dry_run=true
				;;
			-d)
				local die=true
				;;
		esac
		shift
	done

	stderr "+ %s\n" "$*"
	if ! "${dry_run}"; then
		if ! "$@" && "${die}"; then
			err_code="$?"
			"${die}" && error -d "command \`%s\` exited with %s\n" "$*" "$?"
		fi
	fi
}

die() {
	[ "$#" -gt 0 ] && stderr "$@"
	#pstree "${PRAXIS_PID:-$$}"
	exit
}

error() {
	local die=false
	case "${1}" in
		-d|--die)
			die=true
			shift
			;;
	esac

	local msg="${1}"; shift
	stderr "${color_red}!!${color_reset} ${msg}" "$@"
	"${die}" && die
}

warning() {
	local msg="${1}"; shift
	stderr "${color_yellow}!?${color_reset} ${msg}" "$@"
}

stderr() {
	printf "$@" >&2
}

