#!/bin/sh

if [ -z "${NO_COLOR}" ]; then
	color_red=$(tput setaf 1)
	color_yellow=$(tput setaf 3)
	color_reset=$(tput sgr0)
fi

pdo() {
	local dry_run=false die=true arg
	while [ $# -gt 0 ] && [ "${1:0:1}" = '-' ]; do
		case "$1" in
			-n)
				local dry_run=true
				;;
			-d)
				local die=false
				;;
		esac
		shift
	done

	stderr "+ %s\n" "$*"
	if ! "${dry_run}"; then
		"$@" || { err_code=$?; "${die}" && perror -d "command \`%s\` exited with %s\n" "$*" "${err_code}"; }
	fi
}

pdie() {
	[ "$#" -gt 0 ] && pstderr "$@"
	exit
}

perror() {
	local die=false
	case "${1}" in
		-d)
			die=true
			shift
			;;
	esac

	local msg="${1}"; shift
	pstderr "${color_red}!!${color_reset} ${msg}" "$@"
	"${die}" && die
}

pwarning() {
	local msg="${1}"; shift
	pstderr "${color_yellow}!?${color_reset} ${msg}" "$@"
}

pstderr() {
	printf "$@" >&2
}

